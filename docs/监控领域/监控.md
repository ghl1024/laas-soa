基于主机: 192.168.2.21

# prometheus

安装

```
rm -rf /data/tristan/prometheus
mkdir -p  /data/tristan/prometheus && chmod 777 /data/tristan/prometheus
mkdir -p  /data/tristan/prometheus/data && chmod 777 /data/tristan/prometheus/data
sudo tee /data/tristan/prometheus/prometheus.yml <<-'EOF'
global:
  scrape_interval:     15s
  evaluation_interval: 15s
alerting:
  alertmanagers:
  - static_configs:
    - targets:
rule_files:
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
    - targets: ['localhost:9090']
EOF

docker sotp prometheus && docker rm prometheus
docker run -d \
  --name=prometheus \
  --restart=always \
  -p 9090:9090 \
  -v /data/tristan/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \
  -v /data/tristan/prometheus/data:/prometheus \
  prom/prometheus:v2.23.0
  
docker logs -f --tail=100 prometheus
```



# grafana

安装

```
rm -rf /data/tristan/grafana
mkdir -p /data/tristan/grafana/configs /data/tristan/grafana/data
chmod 777 /data/tristan/grafana/configs /data/tristan/grafana/data

docker stop grafana && docker rm grafana
docker run -d \
  --name=grafana \
  --restart=always \
  -p 80:3000 \
  -v /data/tristan/grafana/data:/var/lib/grafana \
  grafana/grafana:7.3.4

docker logs -f --tail=100 grafana
```

添加数据源



# exporter

node_exporter

redis

zookeeper

# alertmanager

```
global:
  resolve_timeout: 2m
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
  wechat_api_secret: 'xxx'
  wechat_api_corp_id: 'xxx'
templates:
- '/etc/alertmanager/template/*.tmpl'
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h
  receiver: team-X-mails
  routes:
  - match_re:
      service: ^(foo1|foo2|baz)$
    receiver: team-X-mails
    routes:
    - match:
        severity: critical
      receiver: team-X-pager
  - match:
      service: files
    receiver: team-Y-mails
    routes:
    - match:
        severity: critical
      receiver: team-Y-pager
```



```
rm -rf /data/tristan/alertmanager
mkdir -p /data/tristan/alertmanager/configs
chmod 777 /data/tristan/alertmanager/configs

sudo tee /data/tristan/alertmanager/configs/config.yml <<-'EOF'

EOF

docker stop alertmanager && docker rm alertmanager
docker run -d \
  --name=alertmanager \
  --restart=always \
  -p 9093:9093 \
  prom/alertmanager:v0.14.0

  -v /data/tristan/alertmanager/configs/config.yml:/etc/alertmanager/config.yml \

```

