# loki

下载安装包安装或者是上传安装包安装

下载安装包安装(适用于服务器网速极好的情况):

```
echo "安装docker-compose"
curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
docker-compose --version
```

上传安装包安装方式(适用于服务器网速不好的情况):

```
mv -f docker-compose-Linux-x86_64 /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
docker-compose --version
```

准备镜像

```
docker rmi grafana/promtail:2.0.0
docker rmi grafana/loki:2.0.0
docker rmi grafana/promtail:2.1.0
docker rmi grafana/loki:2.1.0

docker pull grafana/promtail:2.1.0
docker pull nginx:1.19
docker pull grafana/loki:2.1.0
```

上传安装包

```
rm -rf /home/data/tristan/loki
mkdir -p /home/data/tristan/loki && chmod 777 /home/data/tristan/loki
mv loki-docker.zip /home/data/tristan/loki
cd /home/data/tristan/loki

yum install -y unzip
unzip loki-docker.zip
chmod 777 /home/data/tristan/loki/chunks
chmod 777 /home/data/tristan/loki/config

echo "拉起镜像"
docker-compose pull


echo "运行"
docker-compose -f ./docker-compose-ha-memberlist.yaml up -d

docker stats

docker logs -f --tail 100 loki_promtail_1
docker logs -f --tail 100 loki_loki-frontend_2
docker logs -f --tail 100 loki_loki-2_1
docker logs -f --tail 100 loki_loki-3_1
docker logs -f --tail 100 loki_loki-1_1
docker logs -f --tail 100 loki_loki-frontend_1
docker logs -f --tail 100 loki_loki-gateway_1


echo "关闭并销毁"
docker-compose -f ./docker-compose-ha-memberlist.yaml down
rm -rf /home/data/tristan/loki/chunks/*
```

添加数据源

```
http://172.30.1.153:3100
```

# 集成promtail

创建promtail配置文件

注意: 给promtail启动时注入两个环境变量: 命名空间、项目名称

创建配置文件

```
sudo tee promtail-config.yaml <<-'EOF'
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
data:
  promtail-config.yaml: |-
    server:
        disable: true
    positions:
        filename: /tmp/positions.yaml
    clients:
        - url: http://test.grafana.wangjiahuan.com:81/loki/api/v1/push
    scrape_configs:
      - job_name: system
        static_configs:
        - targets:
            - localhost
          labels:
            job: service_log
            __path__: /mnt/*/*/*.log
            hostname: ${HOSTNAME}
            namespace: ${NAMESPACE}
            service: ${SERVICE_NAME}
EOF
```

创建

```
kubectl -n dev apply -f promtail-config.yaml
kubectl -n dev get configmap promtail-config -o yaml
```

添加伴生容器

```
      - args:
        - -config.file=/etc/promtail/promtail-config.yaml
        - -config.expand-env=true
        image: grafana/promtail:2.1.0
        imagePullPolicy: Always
        name: promtail
        env:
        - name: SERVICE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        resources:
          limits:
            cpu: 1
            memory: 100M
          requests:
            cpu: 250m
            memory: 100M
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/localtime
          name: date-config
        - mountPath: /mnt
          name: logs-dir
        - mountPath: /etc/promtail/promtail-config.yaml
          name: promtail-config
          readOnly: true
          subPath: promtail-config.yaml
```

添加全局数据卷

```
      volumes:
      - name: promtail-config
        configMap:
          name: promtail-config
```



# 参考文档

https://github.com/grafana/loki

https://grafana.com/docs/loki/latest/

https://hub.docker.com/r/grafana/loki

https://grafana.com/docs/loki/latest/installation/docker/

https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-centos-7

https://github.com/docker/compose/releases/tag/1.27.4

https://docs.docker.com/config/containers/start-containers-automatically/

